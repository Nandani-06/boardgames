#!/bin/bash

# Usage check
if [ -z "$1" ]; then
  echo "Usage: $0 <cleaned_input_file.tsv>"
  exit 1
fi

input_file="$1"

# ----------------------------
# Function: Count occurrences in semicolon-separated column
# ----------------------------
count_occurrences() {
  local col="$1"
  local label="$2"
  awk -F'\t' -v c="$col" -v name="$label" '
    NR > 1 && $c != "" {
      n = split($c, parts, ";")
      for (i = 1; i <= n; i++) {
        gsub(/^ +| +$/, "", parts[i])
        count[parts[i]]++
      }
    }
    END {
      max = 0
      for (item in count) {
        if (count[item] > max) {
          max = count[item]
          popular = item
        }
      }
      printf "The most popular %s is %s found in %d games\n", name, popular, max
    }
  ' "$input_file"
}

# ----------------------------
# Function: Pearson Correlation using temporary file
# ----------------------------
calculate_correlation() {
  local file="$1"

  local sum_x=0 sum_y=0 n=0
  while read -r x y; do
    sum_x=$(echo "$sum_x + $x" | bc -l)
    sum_y=$(echo "$sum_y + $y" | bc -l)
    ((n++))
  done < "$file"

  if [ "$n" -eq 0 ]; then
    echo "0.000"
    return
  fi

  local mean_x=$(echo "$sum_x / $n" | bc -l)
  local mean_y=$(echo "$sum_y / $n" | bc -l)

  local sum_xy=0 sum_x2=0 sum_y2=0
  while read -r x y; do
    dx=$(echo "$x - $mean_x" | bc -l)
    dy=$(echo "$y - $mean_y" | bc -l)
    sum_xy=$(echo "$sum_xy + ($dx * $dy)" | bc -l)
    sum_x2=$(echo "$sum_x2 + ($dx * $dx)" | bc -l)
    sum_y2=$(echo "$sum_y2 + ($dy * $dy)" | bc -l)
  done < "$file"

  if [ "$(echo "$sum_x2 == 0" | bc -l)" -eq 1 ] || [ "$(echo "$sum_y2 == 0" | bc -l)" -eq 1 ]; then
    echo "0.000"
  else
    printf "%.3f\n" "$(echo "$sum_xy / sqrt($sum_x2 * $sum_y2)" | bc -l)"
  fi
}

# ----------------------------
# 1. Most popular game mechanics (column 13)
# ----------------------------
count_occurrences 13 "game mechanics"

# ----------------------------
# 2. Most popular game domain (column 14)
# ----------------------------
count_occurrences 14 "game domain"

# ----------------------------
# 3. Correlation: Year (3) vs Rating Average (9)
# ----------------------------
tmp1=$(mktemp)
awk -F'\t' 'NR > 1 && $3 ~ /^[0-9]+$/ && $9 ~ /^[0-9]+(\.[0-9]+)?$/ { print $3, $9 }' "$input_file" > "$tmp1"
correlation1=$(calculate_correlation "$tmp1")
rm -f "$tmp1"
echo "The correlation between the year of publication and the average rating is $correlation1"

# ----------------------------
# 4. Correlation: Complexity Average (11) vs Rating Average (9)
# ----------------------------
tmp2=$(mktemp)
awk -F'\t' 'NR > 1 && $11 ~ /^[0-9]+(\.[0-9]+)?$/ && $9 ~ /^[0-9]+(\.[0-9]+)?$/ { print $11, $9 }' "$input_file" > "$tmp2"
correlation2=$(calculate_correlation "$tmp2")
rm -f "$tmp2"
echo "The correlation between the complexity of a game and its average rating is $correlation2"

